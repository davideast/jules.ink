---
import AppLayout from '../layouts/AppLayout.astro';
import { SessionListPage } from '../components/pages/SessionListPage';
import { SetupPage } from '../components/pages/SetupPage';
import { checkKeysConfigured } from '../lib/api-keys';
import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const ROOT_DIR = process.env.JULES_INK_ROOT || path.resolve(__dirname, '../../../');
const SESSIONS_CACHE_FILE = path.join(ROOT_DIR, '.jules', 'sessions-cache.json');

const keysConfigured = await checkKeysConfigured();

let initialSessions: any[] = [];
let initialNextPageToken: string | null = null;
let initialError: string | null = null;

if (keysConfigured) {
  // Read from our own file cache — written by /api/sessions on each background fetch.
  // Pure local file read, no network, no SDK. Instant SSR.
  try {
    const raw = await fs.readFile(SESSIONS_CACHE_FILE, 'utf-8');
    const cached = JSON.parse(raw);
    if (cached.sessions?.length > 0) {
      initialSessions = cached.sessions;
    }
  } catch {
    // No cache yet (first-ever visit) — client will background-fetch and populate it.
  }
}
---

<AppLayout title="jules.ink">
  {keysConfigured ? (
    <SessionListPage
      client:load
      initialSessions={initialSessions}
      initialNextPageToken={initialNextPageToken}
      initialError={initialError}
    />
  ) : (
    <SetupPage client:load />
  )}
</AppLayout>
