---
import AppLayout from '../layouts/AppLayout.astro';
import { SessionPage } from '../components/pages/SessionPage';

const sessionId = Astro.url.searchParams.get('id') || '';
const tone = Astro.url.searchParams.get('tone') || undefined;
const model = Astro.url.searchParams.get('model') || undefined;

let sessionMeta = null;
if (sessionId) {
  try {
    const { connect } = await import('@google/jules-sdk');
    const jules = connect();

    // Cache-only lookup — pure local, no network risk.
    // The landing page's jules.sessions() call writes through to cache,
    // so this will hit for any session the user has seen before.
    const results = await jules.select({
      from: 'sessions' as const,
      where: { id: sessionId },
      limit: 1,
    });
    const info = results[0] ?? null;

    if (info) {
      const rawState = String(info.state || '').toLowerCase();
      let status: 'completed' | 'in_progress' | 'failed' = 'in_progress';
      if (rawState === 'completed') status = 'completed';
      else if (rawState === 'failed') status = 'failed';
      sessionMeta = {
        title: info.title || '',
        repo: info.sourceContext?.source?.replace('sources/github/', '') || '',
        status,
        prompt: info.prompt || '',
      };
    }
    // Cache miss (first-ever visit) — render shell without metadata.
    // The streaming flow will populate it client-side.
  } catch (err: any) {
    console.error('[SSR] Failed to load session info:', err);
  }
}
---

<AppLayout title={sessionMeta?.title ? `${sessionMeta.title} — jules.ink` : 'jules.ink — Session'}>
  <SessionPage
    client:load
    sessionId={sessionId}
    sessionTitle={sessionMeta?.title}
    sessionRepo={sessionMeta?.repo}
    sessionStatus={sessionMeta?.status}
    sessionPrompt={sessionMeta?.prompt}
    initialTone={tone}
    initialModel={model}
  />
</AppLayout>
